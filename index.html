<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Matrix AR - Visual Fix</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@900&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; background: #000; overflow: hidden; touch-action: none; font-family: sans-serif; height: 100vh; }
        #media-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        #bg-video { width: 100%; height: 100%; object-fit: cover; display: none; }
        #canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        
        #app-ui { 
            position: absolute; bottom: 0; left: 0; width: 100%; z-index: 100; 
            background: rgba(0,0,0,0.8); backdrop-filter: blur(15px); 
            border-top: 1px solid #0f4; padding-bottom: env(safe-area-inset-bottom);
            transition: transform 0.3s ease;
        }
        #app-ui.hidden { transform: translateY(110%); }

        .ui-content { padding: 15px 0; display: flex; flex-direction: column; align-items: center; gap: 8px; }
        .ui-row { width: 90%; display: flex; justify-content: space-between; align-items: center; gap: 8px; }
        .btn { flex: 1; height: 40px; background: #111; border: 1px solid #0f4; border-radius: 4px; color: #0f4; font-weight: bold; font-size: 11px; }
        input[type="text"] { background: #000; border: 1px solid #0f4; color: #fff; padding: 8px; border-radius: 4px; flex: 1.2; font-size: 14px; }
        #decodeMessageInput { border-color: #f44; color: #fcc; }
        .control-group { flex: 1; display: flex; flex-direction: column; }
        label { color: #0f4; font-size: 9px; font-weight: bold; margin-bottom: 2px; }
        input[type="range"] { width: 100%; accent-color: #0f4; }
        
        /* é€æ˜é®ç½©ç”¨æ–¼å–šé†’ UI */
        #touch-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; }
    </style>
</head>
<body>

<div id="media-bg"><video id="bg-video" autoplay playsinline muted></video></div>
<div id="canvas-container"></div>
<div id="touch-overlay"></div>

<div id="app-ui">
    <div class="ui-content">
        <div class="ui-row">
            <input type="text" id="textInput" value="å±¤æ¬¡çŸ©é™£">
            <button class="btn" id="fullScreenBtn">ğŸ”² éš±è—ä»‹é¢</button>
            <button class="btn" id="camBtn">ğŸ“· é¡é ­</button>
        </div>
        <div class="ui-row">
            <input type="text" id="decodeMessageInput" value="éƒ­ç™½å…­æ˜¯å¯æ„›çš„å°æœ‹å‹">
            <button class="btn" id="setDecodeBtn" style="border-color:#f44; color:#f44;">ç ´è§£</button>
        </div>
        <div class="ui-row">
            <div class="control-group">
                <label>Rows: <span id="rowVal">12</span></label>
                <input type="range" id="rowSlider" min="4" max="60" step="2" value="12">
            </div>
            <div class="control-group">
                <label>Speed</label>
                <input type="range" id="speedSlider" min="1" max="10" step="0.5" value="4">
            </div>
        </div>
    </div>
</div>

<script type="importmap"> { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } } </script>

<script type="module">
    import * as THREE from 'three';

    class MatrixARModule {
        constructor() {
            this.scene = new THREE.Scene();
            this.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            this.renderer.setSize(window.innerWidth, window.innerHeight);
            this.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            document.getElementById('canvas-container').appendChild(this.renderer.domElement);

            this.camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 1, 5000);
            this.camera.position.z = 1000;
            
            this.params = { speed: 4, midRows: 12, decodeMessage: "éƒ­ç™½å…­æ˜¯å¯æ„›çš„å°æœ‹å‹", decodeIdx: 0, lastDecodeTime: 0, decodeInterval: 200, chars: "è™šå®Ÿæ•°è§£ç©ºé–“01ãƒ›UNKOWN" };
            this.charGroups = [];
            
            this._bindUI();
            this.updateText();
            this._animate();
            window.addEventListener('resize', () => this.onResize());
        }

        onResize() {
            this.renderer.setSize(window.innerWidth, window.innerHeight);
            this.camera.aspect = window.innerWidth / window.innerHeight;
            this.camera.updateProjectionMatrix();
            this.updateText();
        }

        _bindUI() {
            const get = (id) => document.getElementById(id);
            const ui = get('app-ui');

            get('rowSlider').oninput = (e) => { 
                this.params.midRows = parseInt(e.target.value); 
                get('rowVal').innerText = this.params.midRows;
                this.updateText(); 
            };
            get('speedSlider').oninput = (e) => this.params.speed = parseFloat(e.target.value);
            get('textInput').oninput = () => this.updateText();
            get('setDecodeBtn').onclick = () => { this.params.decodeIdx = 0; this.params.decodeMessage = get('decodeMessageInput').value; };
            get('camBtn').onclick = () => this.startCamera();
            
            get('fullScreenBtn').onclick = () => {
                const el = document.documentElement;
                const rfs = el.requestFullscreen || el.webkitRequestFullScreen;
                if(rfs) rfs.call(el).catch(()=>{});
                ui.classList.add('hidden');
            };

            get('touch-overlay').onclick = (e) => {
                if (ui.classList.contains('hidden')) ui.classList.remove('hidden');
                else if (e.clientY < window.innerHeight * 0.6) ui.classList.add('hidden');
            };
        }

        _createTex(char, isNear, isRed) {
            const canvas = document.createElement('canvas'); canvas.width = 256; canvas.height = 256;
            const ctx = canvas.getContext('2d');
            ctx.font = '900 200px "Noto Sans TC"';
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillStyle = isRed ? "#f44" : (isNear ? "#cfd" : "#0f4");
            ctx.shadowBlur = 15; ctx.shadowColor = isRed ? "#f00" : "#0f4";
            ctx.fillText(char, 128, 128);
            return new THREE.CanvasTexture(canvas);
        }

        updateText() {
            this.charGroups.forEach(g => {
                g.children[0].material.map.dispose();
                this.scene.remove(g);
            });
            this.charGroups = [];

            const layers = [
                { n: 'F', z: -800, sz: 60, m: 2.0 },
                { n: 'M', z: 0,    sz: 90, m: 1.0 },
                { n: 'N', z: 450,  sz: 130,m: 0.6 }
            ];

            layers.forEach(l => {
                const rows = Math.max(1, Math.floor(this.params.midRows * l.m));
                // æ ¸å¿ƒä¿®æ­£ï¼šå‹•æ…‹è¨ˆç®— X é–“è·ï¼Œç¢ºä¿ä¸è¶…å‡ºè¢å¹• (è¢å¹•å¯¬åº¦ç´„ 1200 å–®ä½)
                const totalWidth = window.innerWidth * (1 + Math.abs(l.z)/1000); 
                const spacing = Math.min(totalWidth / rows, l.sz * 1.5);

                for (let r = 0; r < rows; r++) {
                    const g = new THREE.Group();
                    const rc = this.params.chars[Math.floor(Math.random()*this.params.chars.length)];
                    const m = new THREE.Mesh(new THREE.PlaneGeometry(l.sz, l.sz), new THREE.MeshBasicMaterial({ map: this._createTex(rc, l.n==='N', false), transparent: true }));
                    g.add(m);
                    g.userData = { l, off: Math.random()*1000, spd: 0.8+Math.random()*0.4, isD: false };
                    g.position.set((r - (rows - 1)/2) * spacing, 2000, l.z);
                    this.scene.add(g);
                    this.charGroups.push(g);
                }
            });
        }

        _animate() {
            const now = Date.now();
            const time = now * 0.001 * this.params.speed;

            if (now - this.params.lastDecodeTime > this.params.decodeInterval) {
                const pool = this.charGroups.filter(g => !g.userData.isD && g.userData.l.n !== 'F' && Math.abs(g.position.y) < 800);
                if (pool.length > 0 && this.params.decodeMessage) {
                    const t = pool[Math.floor(Math.random()*pool.length)];
                    t.children[0].material.map.dispose();
                    t.children[0].material.map = this._createTex(this.params.decodeMessage[this.params.decodeIdx], t.userData.l.n==='N', true);
                    t.userData.isD = true;
                    this.params.decodeIdx = (this.params.decodeIdx + 1) % this.params.decodeMessage.length;
                    this.params.lastDecodeTime = now;
                }
            }

            this.charGroups.forEach(g => {
                const p = (time * g.userData.l.m * g.userData.spd + g.userData.off) % 6;
                g.position.y = 1500 - p * 600;
                if (g.position.y < -1100 && g.userData.isD) {
                    g.userData.isD = false;
                    const rc = this.params.chars[Math.floor(Math.random()*this.params.chars.length)];
                    g.children[0].material.map.dispose();
                    g.children[0].material.map = this._createTex(rc, g.userData.l.n==='N', false);
                }
            });
            this.renderer.render(this.scene, this.camera);
            requestAnimationFrame(() => this._animate());
        }

        async startCamera() {
            try {
                const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                const v = document.getElementById('bg-video');
                v.srcObject = s; v.style.display = 'block';
            } catch(e) { alert("è«‹æˆæ¬Šç›¸æ©Ÿä¸¦ä½¿ç”¨ HTTPS"); }
        }
    }
    new MatrixARModule();
</script>
</body>
</html>
